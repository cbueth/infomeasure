"""Explicit Kraskov-Stoegbauer-Grassberger mutual information estimator tests."""

import pytest
from numpy import std, linspace, inf

from infomeasure.measures.mutual_information import KSGMIEstimator


@pytest.mark.parametrize(
    "data_x,data_y,k,minkowski_p,expected",
    [
        ([1.0, 1.2, 0.9, 1.1, 1.3], [1.3, 1.1, 0.9, 1.2, 1.0], 4, 1, -0.25),
        ([1.0, 1.2, 0.9, 1.1, 1.3], [1.3, 1.1, 0.9, 1.2, 1.0], 4, 2, -0.25),
        ([1.0, 1.2, 0.9, 1.1, 1.3], [1.3, 1.1, 0.9, 1.2, 1.0], 4, 3, -0.25),
        ([1.0, 1.2, 0.9, 1.1, 1.3], [1.3, 1.1, 0.9, 1.2, 1.0], 1, 2, -0.85),
        ([1.0, 1.2, 0.9, 1.1, 1.3], [1.3, 1.1, 0.9, 1.2, 1.0], 2, 2, -0.1833333),
        ([1.0, 1.2, 0.9, 1.1, 1.3], [1.3, 1.1, 0.9, 1.2, 1.0], 3, 2, -0.4833333),
        ([1.0, 1.25, 0.91, 1.13, 1.32], [1.3, 1.1, 0.9, 1.2, 1.0], 1, inf, -0.5833333),
        ([1.01, 1.23, 0.92, 1.14, 1.3], [1.3, 1.1, 0.9, 1.2, 1.0], 2, inf, -0.1833333),
        ([1.04, 1.23, 0.92, 1.1, 1.34], [1.3, 1.1, 0.9, 1.2, 1.0], 3, inf, -0.2833333),
        (linspace(0, 1, 100), linspace(0, 1, 100), 4, 1, 1.6171394224015256),
        (linspace(0, 1, 100), linspace(0, 1, 100), 4, 2, 2.828044184306288),
        (linspace(0, 1, 100), linspace(0, 1, 100), 4, 3, 2.8360441843062887),
        (linspace(0, 1, 100), linspace(0, 1, 100), 1, 2, 2.1973775176396204),
        (linspace(0, 1, 100), linspace(0, 1, 100), 2, 2, 3.177377517639621),
        (linspace(0, 1, 100), linspace(0, 1, 100), 3, 2, 2.520710850972955),
        (linspace(0, 1, 100), linspace(1, 0, 100), 3, 2, 2.520710850972955),
        (
            [-2.49, 1.64, -3.05, 7.95, -5.96, 1.77, -5.24, 7.03, -0.11, -1.86],
            [-8.59, 8.41, 3.76, 3.77, 5.69, 1.75, -3.2, -4.0, -4.0, 6.85],
            4,
            inf,
            -0.22710317460317464,
        ),
        (
            [-2.49, 1.64, -3.05, 7.95, -5.96, 1.77, -5.24, 7.03, -0.11, -1.86],
            [11.08, 8.41, 11.47, 8.78, 14.09, 6.03, 10.67, 9.45, 12.72, 11.12],
            4,
            inf,
            -0.12253968253968255,
        ),
        (
            [-2.49, 1.64, -3.05, 7.95, -5.96, 1.77, -5.24, 7.03, -0.11, -1.86],
            [-2.49, 1.64, -3.05, 7.95, -5.96, 1.77, -5.24, 7.03, -0.11, -1.86],
            4,
            inf,
            0.49563492063492054,
        ),
        (
            [0.32, -0.89, -0.01, 1.56, 0.24, 1.78, -1.63, 0.82, 0.12, 2.29],
            [0.22, -0.99, -0.11, 1.46, 0.14, 1.68, -1.73, 0.72, 0.02, 2.19],
            4,
            inf,
            0.49563492063492054,
        ),
        (
            [1.8, 1.1, 1.8, 1.1, 1.8, -2.0, 1.1, 1.8, -2.0, 1.1],
            [-0.6, 0.4, -0.6, -0.6, -1.3, -1.3, -1.3, -0.6, -0.6, 0.4],
            4,
            inf,
            -0.4801587301587301,
        ),
    ],
)
def test_ksg_mi(data_x, data_y, k, minkowski_p, expected):
    """Test the Kraskov-Stoegbauer-Grassberger mutual information estimator."""
    est = KSGMIEstimator(
        data_x,
        data_y,
        k=k,
        minkowski_p=minkowski_p,
        noise_level=0,  # for reproducibility
    )
    res = est.results()
    assert res[0] == pytest.approx(expected)
    assert res[2] == std(res[1])


@pytest.mark.parametrize(
    "data_x,data_y,k,minkowski_p,expected",
    [
        ([1.0, 1.2, 0.9, 1.1, 1.3], [1.3, 1.1, 0.9, 1.2, 1.0], 4, 1, -0.25),
        ([1.0, 1.2, 0.9, 1.1, 1.3], [1.3, 1.1, 0.9, 1.2, 1.0], 4, 2, -0.25),
        ([1.0, 1.2, 0.9, 1.1, 1.3], [1.3, 1.1, 0.9, 1.2, 1.0], 4, 3, -0.25),
        ([1.0, 1.2, 0.9, 1.1, 1.3], [1.3, 1.1, 0.9, 1.2, 1.0], 1, 2, -0.85),
        ([1.0, 1.2, 0.9, 1.1, 1.3], [1.3, 1.1, 0.9, 1.2, 1.0], 2, 2, -0.1833333),
        ([1.0, 1.2, 0.9, 1.1, 1.3], [1.3, 1.1, 0.9, 1.2, 1.0], 3, 2, -0.4833333),
        ([1.0, 1.25, 0.91, 1.13, 1.32], [1.3, 1.1, 0.9, 1.2, 1.0], 1, inf, -0.5833333),
        ([1.01, 1.23, 0.92, 1.14, 1.3], [1.3, 1.1, 0.9, 1.2, 1.0], 2, inf, -0.1833333),
        ([1.04, 1.23, 0.92, 1.1, 1.34], [1.3, 1.1, 0.9, 1.2, 1.0], 3, inf, -1 / 3),
        (linspace(0, 1, 100), linspace(0, 1, 100), 4, 1, 1.6171394224015256),
        (linspace(0, 1, 100), linspace(0, 1, 100), 4, 2, 2.828044184306288),
        (linspace(0, 1, 100), linspace(0, 1, 100), 4, 3, 2.8360441843062887),
        (linspace(0, 1, 100), linspace(0, 1, 100), 1, 2, 2.1973775176396204),
        (linspace(0, 1, 100), linspace(0, 1, 100), 2, 2, 3.177377517639621),
        (linspace(0, 1, 100), linspace(0, 1, 100), 3, 2, 2.520710850972955),
        (linspace(0, 1, 100), linspace(1, 0, 100), 3, 2, 2.520710850972955),
        (
            [-2.49, 1.64, -3.05, 7.95, -5.96, 1.77, -5.24, 7.03, -0.11, -1.86],
            [-8.59, 8.41, 3.76, 3.77, 5.69, 1.75, -3.2, -4.0, -4.0, 6.85],
            4,
            inf,
            -0.24710317460317466,
        ),
        (
            [-2.49, 1.64, -3.05, 7.95, -5.96, 1.77, -5.24, 7.03, -0.11, -1.86],
            [11.08, 8.41, 11.47, 8.78, 14.09, 6.03, 10.67, 9.45, 12.72, 11.12],
            4,
            inf,
            0.015595238095237995,
        ),
        (
            [-2.49, 1.64, -3.05, 7.95, -5.96, 1.77, -5.24, 7.03, -0.11, -1.86],
            [-2.49, 1.64, -3.05, 7.95, -5.96, 1.77, -5.24, 7.03, -0.11, -1.86],
            4,
            inf,
            0.49563492063492054,
        ),
        (
            [0.32, -0.89, -0.01, 1.56, 0.24, 1.78, -1.63, 0.82, 0.12, 2.29],
            [0.22, -0.99, -0.11, 1.46, 0.14, 1.68, -1.73, 0.72, 0.02, 2.19],
            4,
            inf,
            0.49563492063492054,
        ),
        (
            [1.8, 1.1, 1.8, 1.1, 1.8, -2.0, 1.1, 1.8, -2.0, 1.1],
            [-0.6, 0.4, -0.6, -0.6, -1.3, -1.3, -1.3, -0.6, -0.6, 0.4],
            4,
            inf,
            -0.5347222222222221,
        ),
    ],
)
def test_ksg_mi_normalized(data_x, data_y, k, minkowski_p, expected):
    """
    Test the Kraskov-Stoegbauer-Grassberger mutual information estimator with normalization.
    """
    est = KSGMIEstimator(
        data_x,
        data_y,
        k=k,
        minkowski_p=minkowski_p,
        noise_level=0,  # for reproducibility
        normalize=True,
    )
    res = est.results()
    assert res[0] == pytest.approx(expected)
    assert res[2] == std(res[1])
