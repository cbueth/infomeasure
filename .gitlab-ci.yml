image: mambaorg/micromamba

stages:
  - test
  - coverage
  - deploy

variables:
  MAMBA_ROOT_PREFIX: ${CI_PROJECT_DIR}/mamba_root
  MAMBA_SKIP_ACTIVATE: 1
  # Cannot activate the environment if the root prefix is off

.pythonVersions:
  parallel:
    matrix:
      - PYTHON_VERSION: [ "3.12", "3.11", "3.10"]
  maxVersion:
    matrix:
      - PYTHON_VERSION: [ "3.12" ]

before_script:
  - mkdir -p ${MAMBA_ROOT_PREFIX}
  - eval "$(micromamba shell hook --shell bash)"
  - micromamba activate ${MAMBA_ROOT_PREFIX}
  - micromamba install -y -n base -c conda-forge python=${PYTHON_VERSION} -f requirements.txt

pre-commit:
  stage: test
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
  parallel: !reference [ .pythonVersions,maxVersion ]
  script:
    - pre-commit run --all-files

test:
  stage: test
  rules:
    - changes:
      - infomeasure/**
      - tests/**
      - pyproject.toml
      - requirements.txt
  parallel: !reference [ .pythonVersions,parallel ]
  script:
    - micromamba list
    - pytest tests/

# coverage report - for merge requests and main branch
coverage:
  stage: coverage
  needs: []
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  parallel: !reference [ .pythonVersions,maxVersion ]
  script:
    - pytest --cov=infomeasure tests/ --cov-report term --cov-report xml:coverage.xml
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

# build documentation to gitlab pages, only on main branch
pages:
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  parallel: !reference [ .pythonVersions,maxVersion ]
  script:
    - sphinx-apidoc -o docs/api/ infomeasure/ -f
    - sphinx-build docs/ public -b dirhtml
  artifacts:
    paths:
      - public
  environment:
    name: production
    url: https://${CI_PROJECT_NAMESPACE}.pages.ifisc.uib-csic.es/${CI_PROJECT_NAME}
